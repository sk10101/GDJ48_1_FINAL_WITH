<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.with.board.dao.DeliveryDAO">
	<update id="endUpdate">
	<![CDATA[
		UPDATE board_common_column 
			SET recruit_end = 1 WHERE deadline <= now()
	]]> 
	</update>

	<select id="deliList" resultType="board">
		SELECT bcc.board_idx
		,subject
		,appoint_place
		,member_id
		,min_delivery
		,write_date
		,DATE_FORMAT(deadline,'%Y-%m-%d %H:%i') as deadline
		,hit
		,member_cnt
		,recruit_end FROM board_common_column bcc, delivery_board d
			WHERE bcc.board_idx = d.board_idx AND category_id = '배달게시판'
				ORDER BY bcc.board_idx DESC
	</select>
	
	<update id="upHit" parameterType="String">
		UPDATE board_common_column SET hit = hit+1
			WHERE board_idx = #{board_idx}
	</update>
	<select id="deliDetail" parameterType="String" resultType="board">
		SELECT bcc.board_idx
		,subject
		,appoint_place
		,member_id
		,min_delivery
		,write_date
		,DATE_FORMAT(deadline,'%Y-%m-%d %H:%i') as deadline
		,hit
		,member_cnt
		,recruit_end
		,gender
		,content
		,appoint_coords_lat
		,appoint_coords_lng
		,min_fund
		,delivery_fee FROM board_common_column bcc, delivery_board d
			WHERE bcc.board_idx = #{board_idx} AND bcc.board_idx = d.board_idx
	</select>
	
	<select id="searchList" resultType="board">
		SELECT bcc.board_idx
		,subject
		,appoint_place
		,member_id
		,min_delivery
		,write_date
		,deadline
		,hit
		,member_cnt
		,recruit_end FROM board_common_column bcc, delivery_board d
		WHERE bcc.board_idx = d.board_idx AND category_id = '배달게시판'
		<if test="param2 != null and param2 != ''">
			<choose>
				<when test="param1.equals('제목')">
					AND subject LIKE CONCAT('%',#{param2},'%')
				</when>
				<when test="param1.equals('약속장소')">
					AND appoint_place LIKE CONCAT('%',#{param2},'%')
				</when>
				<when test="param1.equals('작성자')">
					AND member_id LIKE CONCAT('%',#{param2},'%')
				</when>
				<otherwise>
				</otherwise>
			</choose>
		</if>
		ORDER BY bcc.board_idx DESC
	</select>
	
	<insert id="writeBcc" parameterType="board">
		INSERT INTO board_common_column (member_id, category_id, subject, content, deadline, appoint_place, appoint_coords_lat, appoint_coords_lng, gender, member_cnt)
			VALUES(#{member_id}, '배달게시판', #{subject}, #{content}, DATE_FORMAT(adddate(now(),interval #{deadline} hour),'%Y-%m-%d %H:%i'), #{appoint_place}, '37.45975', '126.95109', #{gender}, #{member_cnt})
	</insert>
	
	<select id="getBoardIdx" resultType="int" parameterType="board">
		SELECT board_idx FROM board_common_column
			WHERE member_id = #{member_id} AND subject = #{subject} AND content = #{content} AND appoint_place = #{appoint_place}
	</select>
	
	<insert id="writeDeli" parameterType="board">
		INSERT INTO delivery_board (board_idx, min_delivery, delivery_fee, min_fund)
			VALUES(#{board_idx}, #{min_delivery}, #{delivery_fee}, #{min_fund})
	</insert>
	
	<insert id="deliFileWrite" parameterType="photo">
		INSERT INTO photo(oriFileName, newFileName, board_idx, category_id)
			VALUES(#{oriFileName},#{newFileName},#{board_idx},#{category_id})
	</insert>
	
	<select id="deliPhotoList" resultType="photo">
		SELECT * FROM photo WHERE board_idx = #{param1} and category_id = #{param2}
	</select>
	
</mapper>


